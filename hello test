import subprocess
import json
import gzip
import os
import traceback
import tempfile


class DynamoDBService:
    def restore_mrsc(self, args):
        """
        Restore MRSC-enabled DynamoDB table from S3 exports using AWS CLI.
        This version is based on your locally tested working script (no boto3).
        """

        # ---- Input Arguments ----
        region = args.region
        s3_bucket = args.s3_bucket
        s3_prefix = args.s3_prefix
        target_table_name = args.target_table
        file_ext = args.file_extension

        print(f" Starting MRSC Restore for table: {target_table_name}")
        print(f" Bucket: {s3_bucket}, Prefix: {s3_prefix}, Region: {region}")

        try:
            # Step 1 ‚Äî List exported files from S3
            print(" Listing exported files from S3 ...")
            cmd_list = ["aws", "s3", "ls", f"s3://{s3_bucket}/{s3_prefix}/"]
            result = subprocess.run(cmd_list, capture_output=True, text=True, check=True)
            files = []

            for line in result.stdout.splitlines():
                parts = line.split()
                if len(parts) == 4:
                    filename = parts[3]
                    if filename.endswith(file_ext) or filename.endswith(".json"):
                        files.append(filename)

            if not files:
                print(f" No files found in s3://{s3_bucket}/{s3_prefix}/")
                return

            print(f" Found {len(files)} file(s) to restore to {target_table_name}\n")

            # Step 2 ‚Äî Process each file
            for filename in files:
                print(f"Processing file: {filename}")
                local_file = os.path.join(tempfile.gettempdir(), filename)

                # Step 2.1 ‚Äî Download file
                subprocess.run(
                    ["aws", "s3", "cp", f"s3://{s3_bucket}/{s3_prefix}/{filename}", local_file, "--region", region],
                    check=True
                )

                # Step 2.2 ‚Äî Decompress if needed
                json_file = None
                try:
                    if filename.endswith(".gz"):
                        json_file = local_file.replace(".gz", "")
                        with gzip.open(local_file, "rb") as f_in, open(json_file, "wb") as f_out:
                            f_out.write(f_in.read())
                        print(f"üóúÔ∏è Decompressed {filename} to {json_file}")
                    else:
                        json_file = local_file
                except Exception as e:
                    print(f" Error decompressing file {filename}: {e}")
                    continue

                # Step 2.3 ‚Äî Validate file existence
                if not json_file or not os.path.exists(json_file):
                    print(f" Skipping missing file: {json_file}")
                    continue

                # Step 3 ‚Äî Restore JSON data to DynamoDB
                try:
                    with open(json_file, "r", encoding="utf-8") as f:
                        content = f.read().strip()
                        if not content:
                            print(f" Skipping empty JSON file: {json_file}")
                            continue
                        data = json.loads(content)

                    # Determine if JSON is list or dictionary
                    items = data if isinstance(data, list) else data.get("Items", [])
                    print(f" Restoring {len(items)} items from {json_file}")

                    # Step 4 ‚Äî Write to DynamoDB
                    for item in items:
                        try:
                            cmd_put = [
                                "aws", "dynamodb", "put-item",
                                "--table-name", target_table_name,
                                "--item", json.dumps(item),
                                "--region", region
                            ]
                            subprocess.run(cmd_put, check=True)
                        except subprocess.CalledProcessError as e:
                            print(f" Failed to insert item from {filename}: {e.stderr}")

                except json.JSONDecodeError as e:
                    print(f" JSON Decode error in {json_file}: {e}")
                except Exception as e:
                    print(f" Unexpected error while restoring {json_file}: {e}")
                    traceback.print_exc()
                finally:
                    # Step 5 ‚Äî Cleanup
                    if os.path.exists(json_file):
                        os.remove(json_file)
                    if os.path.exists(local_file):
                        os.remove(local_file)

            print(f"üéâ MRSC Restore process completed successfully for table {target_table_name}")

        except subprocess.CalledProcessError as e:
            print(f" AWS CLI command failed: {e.stderr}")
        except Exception as e:
            print(f" Unexpected error during MRSC restore: {e}")
            traceback.print_exc()
